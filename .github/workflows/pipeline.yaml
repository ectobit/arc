name: pipeline

on:
  push:
  pull_request:

jobs:
  check:
    uses: ectobit/reusable-workflows/.github/workflows/go-check.yaml@main
    with:
      test-command: make test
  flags:
    runs-on: ubuntu-latest
    needs: check
    outputs:
      flags: ${{ steps.flags.outputs.flags }}
    steps:
      - name: Set up linker flags
        id: flags
        run: |
          if  [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${GITHUB_SHA::8}
          fi
          BUILD_DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          LD_FLAGS="-s -w -extldflags '-static' -X main.version=${VERSION} -X main.revision=${GITHUB_SHA} -X main.buildDate=${BUILD_DATE}"
          echo ::set-output name=flags::${LD_FLAGS}
  build:
    uses: ectobit/reusable-workflows/.github/workflows/buildx.yaml@main
    needs: flags
    with:
      image: ectobit/arc
      hadolint-ignore: DL3006
      build-args: LD_FLAGS=${{ needs.flags.outputs.flags }}
    secrets:
      container-registry-username: ${{ secrets.CONTAINER_REGISTRY_USERNAME }}
      container-registry-password: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
